<!DOCTYPE html>
<html>
  <head>
    <title>FastAPI Chat with Video</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:Arial,sans-serif;background:#f5f5f5;height:100vh;display:flex;flex-direction:column}
      .container{max-width:100%;margin:0;padding:10px;height:100%;display:flex;flex-direction:column}
      .setup{background:white;padding:15px;border-radius:8px;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
      .setup input,.setup button{width:100%;padding:12px;margin:5px 0;border:1px solid #ddd;border-radius:4px;font-size:16px}
      .setup button{background:#007bff;color:white;border:none;cursor:pointer}
      .setup button:hover{background:#0056b3}
      .chat-interface{flex:1;display:none;flex-direction:column;background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
      .chat-header{background:#007bff;color:white;padding:15px;font-weight:bold;display:flex;justify-content:space-between;align-items:center}
      .video-controls{display:flex;gap:8px}
      .video-controls button{padding:8px 12px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px}
      .chat-area{flex:1;padding:10px;overflow-y:auto;background:#fafafa}
      .message{margin:5px 0;padding:8px 12px;background:white;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
      .video-message{background:#e8f5e8;border-left:4px solid #28a745}
      .live-stream-message{background:#fff3cd;border-left:4px solid #ffc107}
      .system-message{background:#e3f2fd;color:#1976d2;font-style:italic}
      .input-area{display:flex;padding:10px;background:#f8f9fa;border-top:1px solid #ddd}
      .input-area input{flex:1;padding:12px;border:1px solid #ddd;border-radius:4px 0 0 4px;font-size:16px}
      .input-area button{padding:12px 20px;border:1px solid #007bff;background:#007bff;color:white;border-radius:0 4px 4px 0;cursor:pointer}
      .status{background:#d4edda;color:#155724;padding:10px;border-radius:4px;margin:10px 0;display:none}
      .rooms-list{max-height:200px;overflow-y:auto}
      .room-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
      .room-item button{padding:6px 12px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer}
      .video-player{margin:10px 0;max-width:100%;height:300px}
      .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}
      .modal-content{background:white;margin:10% auto;padding:20px;width:90%;max-width:500px;border-radius:8px}
      .close{float:right;font-size:24px;cursor:pointer}
      .video-upload{background:#f8f9fa;padding:15px;margin:10px 0;border-radius:8px;border:2px dashed #007bff}
      .live-stream-info{background:#fff3cd;padding:10px;margin:10px 0;border-radius:4px;border:1px solid #ffeaa7}
      @media (max-width:480px){.container{padding:5px}.setup{padding:10px}.chat-header{padding:10px}.input-area{padding:5px}.video-controls{flex-direction:column;gap:4px}.video-controls button{font-size:10px;padding:6px 8px}}
    </style>
  </head>
  <body>
    <div class="container">
      <div id="setup" class="setup">
        <h3>FastAPI Chat with Video</h3>
        <input type="text" id="username" placeholder="Enter username" maxlength="20">
        <button onclick="createUser()">Create User</button>
        <input type="text" id="roomName" placeholder="Enter room name" maxlength="30">
        <button onclick="createRoom()">Create Room</button>
        <button onclick="loadRooms()">Load Rooms</button>
        <div id="roomsList" class="rooms-list"></div>
      </div>

      <div id="chatInterface" class="chat-interface">
        <div id="chatHeader" class="chat-header">
          <span id="roomTitle">Chat Room</span>
          <div class="video-controls">
            <button onclick="startLiveStream()">🔴 Live</button>
            <button onclick="uploadVideo()">📹 Upload</button>
          </div>
        </div>
        <div id="chatArea" class="chat-area"></div>
        <div class="input-area">
          <input type="text" id="messageInput" placeholder="Type message..." maxlength="500" onkeypress="if(event.key==='Enter')sendMessage()">
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>

      <div id="liveStreamModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeLiveStreamModal()">&times;</span>
          <h3>Start Live Stream</h3>
          <input type="text" id="streamTitle" placeholder="Stream title" style="width:100%;margin:10px 0;padding:10px;border:1px solid #ddd;border-radius:4px">
          <button onclick="createLiveStream()" style="width:100%;padding:12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer">Create Live Stream</button>
          <div id="streamInfo" class="live-stream-info" style="display:none">
            <h4>🔴 Stream Created!</h4>
            <p><strong>Stream Key:</strong> <span id="streamKey"></span></p>
            <p><strong>RTMP URL:</strong> rtmp://rtmp.bunnycdn.com/live/</p>
            <p><small>Use in OBS or streaming software</small></p>
          </div>
        </div>
      </div>

      <div id="videoUploadModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeVideoUploadModal()">&times;</span>
          <h3>Upload Video</h3>
          <input type="text" id="videoTitle" placeholder="Video title" style="width:100%;margin:10px 0;padding:10px;border:1px solid #ddd;border-radius:4px">
          <input type="text" id="videoDescription" placeholder="Description (optional)" style="width:100%;margin:10px 0;padding:10px;border:1px solid #ddd;border-radius:4px">
          <button onclick="createVideoUpload()" style="width:100%;padding:12px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer">Get Upload URL</button>
          <div id="uploadArea" class="video-upload" style="display:none">
            <input type="file" id="videoFile" accept="video/*" style="margin:10px 0">
            <button onclick="uploadVideoFile()" style="width:100%;padding:12px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer">Upload Video</button>
            <div id="uploadProgress" style="margin:10px 0"></div>
          </div>
        </div>
      </div>

      <div id="status" class="status"></div>
    </div>

    <script>
      let ws=null,currentUser=null,currentRoom=null;
      function startLiveStream(){document.getElementById('liveStreamModal').style.display='block'}
      function closeLiveStreamModal(){document.getElementById('liveStreamModal').style.display='none'}
      function uploadVideo(){document.getElementById('videoUploadModal').style.display='block'}
      function closeVideoUploadModal(){document.getElementById('videoUploadModal').style.display='none'}

      async function createLiveStream(){
        if(!currentRoom){alert('Join a room first');return}
        const title=document.getElementById('streamTitle').value.trim();
        if(!title){alert('Enter stream title');return}
        try{
          const response=await fetch(`/rooms/${currentRoom.id}/live-stream`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title})});
          if(response.ok){
            const stream=await response.json();
            document.getElementById('streamKey').textContent=stream.stream_key;
            document.getElementById('streamInfo').style.display='block'
          }else{alert('Failed to create live stream')}
        }catch(error){alert('Error: '+error.message)}
      }

      async function createVideoUpload(){
        if(!currentRoom){alert('Join a room first');return}
        const title=document.getElementById('videoTitle').value.trim();
        const description=document.getElementById('videoDescription').value.trim();
        if(!title){alert('Enter video title');return}
        try{
          const response=await fetch(`/rooms/${currentRoom.id}/video-upload`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,description})});
          if(response.ok){
            const upload=await response.json();
            window.uploadUrl=upload.upload_url;
            document.getElementById('uploadArea').style.display='block'
          }else{alert('Failed to create upload URL')}
        }catch(error){alert('Error: '+error.message)}
      }

      async function uploadVideoFile(){
        const fileInput=document.getElementById('videoFile');
        const file=fileInput.files[0];
        if(!file){alert('Select a video file');return}
        if(!window.uploadUrl){alert('Create upload URL first');return}
        const progressDiv=document.getElementById('uploadProgress');
        progressDiv.innerHTML='Uploading...';
        try{
          const response=await fetch(window.uploadUrl,{method:'PUT',body:file,headers:{'Content-Type':file.type}});
          if(response.ok){
            progressDiv.innerHTML='Upload complete! Processing video...';
            closeVideoUploadModal()
          }else{progressDiv.innerHTML='Upload failed'}
        }catch(error){progressDiv.innerHTML='Upload error: '+error.message}
      }

      function displayMessage(data){
        const chatArea=document.getElementById('chatArea');
        const messageDiv=document.createElement('div');
        if(data.type==='message'){
          messageDiv.className='message';
          const time=new Date(data.timestamp.endsWith('Z')?data.timestamp:data.timestamp+'Z').toLocaleTimeString();
          messageDiv.innerHTML='<strong>'+data.username+'</strong> <small>('+time+')</small><br>'+data.content
        }else if(data.type==='live_stream_created'){
          messageDiv.className='message live-stream-message';
          messageDiv.innerHTML='<strong>🔴 Live Stream Started</strong><br>'+data.message+'<br><video controls class="video-player" preload="metadata"><source src="'+data.pull_url+'" type="application/x-mpegURL"></video>'
        }else if(data.type==='video_ready'){
          messageDiv.className='message video-message';
          messageDiv.innerHTML='<strong>🎥 Video Ready</strong><br>'+data.message+'<br><video controls class="video-player" preload="metadata"><source src="'+data.playback_url+'" type="application/x-mpegURL"></video>'
        }else{messageDiv.className='message system-message';messageDiv.textContent=data.message}
        chatArea.appendChild(messageDiv);
        const videos = messageDiv.querySelectorAll('video');
        videos.forEach(video => {
          const source = video.querySelector('source');
          if (source && source.type === 'application/x-mpegURL') {
            if (Hls.isSupported()) {
              const hls = new Hls();
              hls.loadSource(source.src);
              hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
              video.src = source.src;
            }
          }
        });
        chatArea.scrollTop=chatArea.scrollTop
      }

      async function createUser(){
        const username=document.getElementById('username').value.trim();
        if(!username){alert('Enter username');return}
        try{
          const response=await fetch('/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username})});
          if(response.ok){currentUser=await response.json();showStatus('User created: '+currentUser.username)}
          else{alert('Failed to create user')}
        }catch(error){alert('Error: '+error.message)}
      }

      async function createRoom(){
        const roomName=document.getElementById('roomName').value.trim();
        if(!roomName){alert('Enter room name');return}
        try{
          const response=await fetch('/rooms',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:roomName})});
          if(response.ok){showStatus('Room created');loadRooms()}
          else{alert('Failed to create room')}
        }catch(error){alert('Error: '+error.message)}
      }

      async function loadRooms(){
        try{
          const response=await fetch('/rooms');
          const rooms=await response.json();
          const roomsList=document.getElementById('roomsList');
          roomsList.innerHTML='<h4>Rooms:</h4>';
          rooms.forEach(room=>{
            const roomDiv=document.createElement('div');
            roomDiv.className='room-item';
            roomDiv.innerHTML='<span>'+room.name+'</span><button onclick="joinRoom(\''+room.id+'\',\''+room.name+'\')">Join</button>';
            roomsList.appendChild(roomDiv)
          })
        }catch(error){alert('Error loading rooms')}
      }

      async function joinRoom(roomId,roomName){
        if(!currentUser){alert('Create user first');return}
        currentRoom={id:roomId,name:roomName};
        
        // ✅ FIXED: Properly check if join succeeds before connecting WebSocket
        try{
          const joinResponse = await fetch('/rooms/'+roomId+'/join({
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id:currentUser.id, username: currentUser.username})
          });
          
          if (!joinResponse.ok) {
            const errorData = await joinResponse.json().catch(() => ({detail: 'Unknown error'}));
            alert('Failed to join room: ' + errorData.detail);
            return; // ✅ Stop here if join fails
          }
          
          console.log('✅ Successfully joined room');
        }catch(error){
          console.error('❌ Error joining room:',error);
          alert('Failed to join room: ' + error.message);
          return; // ✅ Stop here if request fails
        }
        
        // ✅ Only connect WebSocket after successful join
        const wsProto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = wsProto + '//' + window.location.host + '/ws/' + encodeURIComponent(roomId) + '/' + encodeURIComponent(currentUser.id);
        
        console.log('🔌 Connecting to WebSocket:', wsUrl);
        ws=new WebSocket(wsUrl);
        
        ws.onopen=function(){
          console.log('✅ WebSocket connected');
          document.getElementById('setup').style.display='none';
          document.getElementById('chatInterface').style.display='flex';
          document.getElementById('roomTitle').textContent='Room: '+roomName;
          showStatus('Connected');
          loadMessages()
        };
        
        ws.onmessage=function(event){
          console.log('📨 Message received:', event.data);
          displayMessage(JSON.parse(event.data))
        };
        
        ws.onclose=function(event){
          console.log('🔌 WebSocket closed:', event.code, event.reason);
          showStatus('Disconnected');
          if (event.code === 4004) {
            alert('Connection closed: ' + (event.reason || 'Room or user not found'));
          }
        };
        
        ws.onerror=function(error){
          console.error('❌ WebSocket error:', error);
          showStatus('Connection error - check console for details');
        }
      }

      async function loadMessages(){
        try{
          const response=await fetch('/rooms/'+currentRoom.id+'/messages');
          const messages=await response.json();
          const chatArea=document.getElementById('chatArea');
          chatArea.innerHTML='';
          messages.forEach(message=>{displayMessage({type:'message',username:message.username,content:message.content,timestamp:message.timestamp})})
        }catch(error){console.error('Error loading messages')}
      }

      function sendMessage(){
        const messageInput=document.getElementById('messageInput');
        const content=messageInput.value.trim();
        if(!content||!ws)return;
        ws.send(JSON.stringify({content}));
        messageInput.value=''
      }

      function showStatus(message){
        const status=document.getElementById('status');
        status.textContent=message;status.style.display='block';
        setTimeout(()=>status.style.display='none',3000)
      }

      window.onload=loadRooms;
    </script>
  </body>
</html>
